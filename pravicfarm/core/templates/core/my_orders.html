{% extends "core/base.html" %}
{% load static %}
{% block content %}
<h2>My Orders</h2>

<table class="table">
  <thead>
    <tr>
      <th>Order Ref</th>
      <th>Product</th>
      <th>Quantity</th>
      <th>Status</th>
      <th>Order Date</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody>
  {% for order in orders %}
    <tr>
      <td>{{ order.order_reference }}</td>
      <td>{{ order.product.name }}</td>
      <td>{{ order.quantity }}</td>
      <td>
        {% if order.status == 'CANCELLED' %}
          <span class="badge bg-danger">Cancelled</span>
        {% elif order.status == 'DELIVERED' %}
          <span class="badge bg-success">Delivered</span>
        {% elif order.status == 'CONFIRMED' %}
          <span class="badge bg-primary">Confirmed</span>
        {% else %}
          <span class="badge bg-warning text-dark">Pending</span>
        {% endif %}
      </td>
      <td>{{ order.order_date|date:"Y-m-d H:i" }}</td>
      <td>
        {% if order.status != 'CANCELLED' %}
          <button class="btn btn-sm btn-danger cancel-btn" data-id="{{ order.id }}">Cancel</button>
        {% else %}
          <em>--</em>
        {% endif %}
      </td>
    </tr>
  {% empty %}
    <tr><td colspan="6">No orders found.</td></tr>
  {% endfor %}
  </tbody>
</table>

<script>
  document.querySelectorAll('.cancel-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const orderId = btn.dataset.id;
      if (confirm('Are you sure you want to cancel this order?')) {
        fetch(`/cancel-order/${orderId}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
          alert(data.message);
          if (data.success) {
            location.reload();
          }
        });
      }
    });
  });
</script>
<script>
  const socket = new WebSocket('ws://' + window.location.host + '/ws/orders/');

  socket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    console.log('Update:', data);
    // Optionally refresh the order list or show a notification
    location.reload();  // auto-refresh page on update
  };

  socket.onclose = function(e) {
    console.error('Socket closed:', e);
  };
</script>

{% endblock %}
